作業流程
===
---

## 訂貨

```
┌─────────────────────────────────────────────────────────────────────────┐
│  階段 1: 業務員訂貨                                                      │
│  ─────────────────                                                      │
│  - 業務員建立/編輯 SPO (可訂 D+2 ~ D+9 的貨)                             │
│  - 可帶入清單（上次/自訂/營業所）                                         │
│  - 儲存時記錄 qty (訂購數量)                                             │
│  - BPF 不存在 → 可編輯                                                   │
└─────────────────────────────────────────────────────────────────────────┘
        │
        ▼ 組長執行凍結
┌─────────────────────────────────────────────────────────────────────────┐
│  階段 2: 組長調整 (BPF.status = FROZEN)                                  │
│  ─────────────────────────────────                                      │
│  - 業務員不可再編輯                                                      │
│  - 組長可調整各 SPOD 的 confirmedQty                                     │
│  - 組長可新增/刪除產品                                                   │
└─────────────────────────────────────────────────────────────────────────┘
        │
        ▼ 組長確認完成
┌─────────────────────────────────────────────────────────────────────────┐
│  階段 3: 確認完成 (BPF.status = CONFIRMED)                               │
│  ─────────────────────────────────────                                  │
│  - 組長也不可再編輯                                                      │
│  - 等待庫務執行彙總                                                      │
└─────────────────────────────────────────────────────────────────────────┘
        │
        ▼ 庫務執行彙總
┌─────────────────────────────────────────────────────────────────────────┐
│  階段 4: 庫務彙總建立 BPO                                                │
│  ─────────────────────────                                              │
│  - 依產品對應工廠分組                                                    │
│  - 每個工廠產生一張 BPO                                                  │
│  - BPOD.qty = 各 SPOD.confirmedQty 加總                                 │
│  - 更新 SPOD.status = AGGREGATED                                        │
│  - BPO 送出給工廠                                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

### 單據關係

```
SPO-1 ─┬─ SPOD (產品A, 工廠1) ──┐
       └─ SPOD (產品B, 工廠1) ──┼──► BPO-1 (工廠1) ──► FDO-1
SPO-2 ─┬─ SPOD (產品A, 工廠1) ──┘
       └─ SPOD (產品C, 工廠2) ──────► BPO-2 (工廠2) ──► FDO-2
```

> 詳見 [業務員訂貨規格書](purchase/SalesPurchase.md) | [營業所訂貨規格書](purchase/BranchPurchase.md)

---

## 收貨

1. 工廠根據 BPO 產生工廠出貨單 (FDO)，隨貨送達營業所
2. 庫務人員進入收貨頁面，選擇待收貨的 FDO
3. 核對每項產品的：數量、批次號、效期
4. 輸入實收數量
5. 確認收貨：
   - 數量相符 → 狀態設為 RECEIVED
   - 數量不符 → 狀態設為 DISCREPANCY，記錄差異
6. 貨品依實收數量入庫（含批次、效期資訊）

> 詳見 [FactoryDeliveryOrder.md](receive/FactoryDeliveryOrder.md)

---

## 配貨

```
┌─────────────────────────────────────────────────────────────────────────┐
│  階段 1: 庫務配貨                                                        │
│  ─────────────                                                          │
│  - 查詢待配貨的 SPOD (BPF.status = CONFIRMED)                            │
│  - 依 FIFO + 業務員優先度分配批次                                         │
│  - 產生 AO + AOD                                                         │
│  - 大庫庫存扣減（預留）                                                   │
└─────────────────────────────────────────────────────────────────────────┘
        │
        ▼ 業務員上班領貨
┌─────────────────────────────────────────────────────────────────────────┐
│  階段 2: 業務員領貨                                                      │
│  ───────────────                                                        │
│  - 查詢待領明細 (AOD.status = PENDING)                                   │
│  - 可包含多張 AO 的明細（不同配貨時間）                                   │
│  - 點貨確認，產生 SRO + SROD                                             │
│  - 更新 AOD.status = RECEIVED                                           │
│  - 庫存移轉至業務員儲位                                                   │
└─────────────────────────────────────────────────────────────────────────┘
```

### 單據關係

```
配貨 1: AO-1 ─┬─ AOD (F1 的貨) ──┐
              ├─ AOD (F2 的貨) ──┼─ 待領清單 ─┐
              └─ AOD (H1 的貨) ──┘            │
                                             ├─► 業務員 S 領貨 ─► SRO-1
配貨 2: AO-2 ─── AOD (H2 的貨) ─── 待領清單 ─┘
```

> 詳見 [配貨單規格書](allocation/AllocationOrder.md) | [業務領貨單規格書](allocation/SalesReceiveOrder.md)

---

## 送貨

```
┌─────────────────────────────────────────────────────────────────────────┐
│  前置: 客戶預訂 (D-2)                                                    │
│  ─────────────────                                                      │
│  - 客戶向業務員預訂 (CPO)                                                │
│  - 業務員參考 CPO 建立 SPO                                               │
└─────────────────────────────────────────────────────────────────────────┘
        │
        ▼ D 日：領貨完成
┌─────────────────────────────────────────────────────────────────────────┐
│  階段 1: 系統產生 SDO                                                    │
│  ───────────────────                                                    │
│  - 根據 CPO 自動產生 SDO                                                 │
│  - 預帶預訂品項                                                          │
└─────────────────────────────────────────────────────────────────────────┘
        │
        ▼ 業務員出發
┌─────────────────────────────────────────────────────────────────────────┐
│  階段 2: 送達客戶                                                        │
│  ─────────────                                                          │
│  - 確認送達                                                              │
│  - 現場作業：                                                            │
│    ├── 銷售：預訂 + 加購                                                 │
│    ├── 退貨：客戶退回                                                    │
│    └── 毀損：送貨損壞                                                    │
└─────────────────────────────────────────────────────────────────────────┘
        │
        ▼ 客戶簽收
┌─────────────────────────────────────────────────────────────────────────┐
│  階段 3: 簽收完成                                                        │
│  ─────────────                                                          │
│  - 客戶確認簽收                                                          │
│  - 產生應收帳款 (AR)                                                     │
│  - 更新庫存                                                              │
└─────────────────────────────────────────────────────────────────────────┘
        │
        ▼ 現場接單
┌─────────────────────────────────────────────────────────────────────────┐
│  階段 4: 接取新訂單                                                      │
│  ───────────────                                                        │
│  - 客戶預訂明後天的貨                                                    │
│  - 建立新 CPO                                                            │
└─────────────────────────────────────────────────────────────────────────┘
```

### 單據關係

```
CPO (客戶預訂)
    │
    ▼ 領貨完成後自動產生
SDO (送貨單)
├── SDOD (SALES) ─ 預訂 + 加購
├── SDOD (RETURN) ─ 退貨
└── SDOD (DAMAGE) ─ 毀損
    │
    ▼ 簽收完成
AR (應收帳款) ─ 銷售 - 退貨
```

> 詳見 [客戶預訂單規格書](delivery/CustomerPreOrder.md) | [送貨單規格書](delivery/SalesDeliveryOrder.md)

---

## 結束 (寄庫、退庫)

```
業務員下班
    │
    ├── 有效貨品（沒賣完）
    │   │
    │   ▼
    │   ┌─────────────────────────────────────────────────────────────────┐
    │   │  寄庫 (SKR)                                                      │
    │   │  ───────────                                                    │
    │   │  - 車上有效貨品暫存大庫冰存                                       │
    │   │  - 隔天自動併入 SRO 領回                                         │
    │   └─────────────────────────────────────────────────────────────────┘
    │
    └── 報廢品（呆品/損壞/召回）
        │
        ▼
        ┌─────────────────────────────────────────────────────────────────┐
        │  退庫 (SRR)                                                      │
        │  ───────────                                                    │
        │  - 報廢品退回大庫待處理區                                         │
        │  - 庫務彙整產生 BRO                                              │
        │  - 退回工廠銷毀                                                  │
        └─────────────────────────────────────────────────────────────────┘
```

### 單據關係

```
業務員下班
├── SKR (寄庫) ──► 隔天併入 SRO 領回
│
└── SRR (退庫) ──► 庫務彙整 ──► BRO (按工廠分) ──► 工廠銷毀
```

### 退庫原因

| 原因 | 說明 |
|------|------|
| STALE | 呆品（含過期、即期、賣不動） |
| DAMAGED | 損壞 |
| RECALLED | 召回 |

> 詳見 [業務員寄庫單規格書](closing/SalesKeepRecord.md) | [業務員退庫單規格書](closing/SalesReturnRecord.md) | [營業所銷退單規格書](closing/BranchReturnOrder.md)

---
