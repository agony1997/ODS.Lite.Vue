營業所銷退單規格書 (BRO)
===
> 主要操作者：庫務
---

## 概述

庫務彙整業務員退庫單 (SRR)，產生營業所銷退單 (BRO)，退回工廠銷毀。

---

## 作業流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│  階段 1: 庫務彙整                                                        │
│  ─────────────                                                          │
│  - 查詢待處理的 SRR (status = PENDING)                                   │
│  - 透過程式產生 BRO                                                      │
│  - 依工廠分組（不同工廠不同 BRO）                                         │
│  - 更新 SRR.status = PROCESSED                                          │
└─────────────────────────────────────────────────────────────────────────┘
        │
        ▼ 退回工廠
┌─────────────────────────────────────────────────────────────────────────┐
│  階段 2: 工廠銷毀                                                        │
│  ─────────────                                                          │
│  - BRO 送出給工廠                                                        │
│  - 工廠確認收回報廢品                                                    │
│  - 更新 BRO.status = RETURNED                                           │
│  - 大庫待處理區庫存扣減                                                  │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 資料結構

### BranchReturnOrder (BRO 營業所銷退單)

| 欄位 | 型別 | 說明 |
|------|------|------|
| broNo | String | 銷退單號 (BRO + 流水號) |
| branchCode | String | 營業所代碼 |
| factoryCode | String | 工廠代碼 |
| returnDate | LocalDate | 銷退日期 |
| status | String | 狀態 |
| createdAt | LocalDateTime | 建立時間 |
| createdBy | String | 建立人員 |
| returnedAt | LocalDateTime | 工廠確認時間 |

### BranchReturnOrderDetail (BROD 銷退單明細)

| 欄位 | 型別 | 說明 |
|------|------|------|
| broNo | String | 銷退單號 |
| itemNo | Integer | 項次 |
| returnNo | String | 來源業務員退庫單 |
| productCode | String | 產品代碼 |
| batchNo | String | 批次號 |
| expiryDate | LocalDate | 效期 |
| qty | Integer | 銷退數量 |
| reason | String | 退庫原因 |
| unit | String | 單位 |

---

## BRO 狀態說明

| 狀態 | 說明 |
|------|------|
| PENDING | 待退回（已產生，尚未送出） |
| RETURNED | 已退回（工廠已確認收回） |

---

## 單據關係

```
SRR-1 (業務員A退庫) ─┬─ SRRD (產品X, 工廠F1) ──┐
                     └─ SRRD (產品Y, 工廠F1) ──┼──► BRO-1 (工廠F1)
SRR-2 (業務員B退庫) ─┬─ SRRD (產品X, 工廠F1) ──┘
                     └─ SRRD (產品Z, 工廠F2) ──────► BRO-2 (工廠F2)
```

> 與 BPO 類似，BRO 也是依工廠分組產生。

---

## 庫存影響

### BRO 產生時

無庫存變化（貨品仍在大庫待處理區）

### 工廠確認收回後

| 儲位 | 變化 |
|------|------|
| 大庫（待處理區） | -qty |

---

## 庫務操作程式

### 功能說明

庫務透過此程式查詢各業務員的退庫單 (SRR)，彙總後產生營業所銷退單 (BRO) 送給工廠。

### 操作流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│  步驟 1: 查詢待處理退庫單                                                │
│  ─────────────────────────                                              │
│  - 選擇營業所                                                            │
│  - 選擇日期區間                                                          │
│  - 顯示各業務員的 SRR 清單 (status = PENDING)                            │
└─────────────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  步驟 2: 檢視退庫明細                                                    │
│  ─────────────────                                                      │
│  - 展開各 SRR 的明細                                                     │
│  - 顯示：產品、批次、數量、退庫原因                                       │
│  - 可按工廠篩選/分組                                                     │
└─────────────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  步驟 3: 產生銷退單                                                      │
│  ─────────────────                                                      │
│  - 勾選要彙整的 SRR                                                      │
│  - 點擊「產生銷退單」                                                    │
│  - 系統依工廠分組產生 BRO                                                │
│  - 更新 SRR.status = PROCESSED                                          │
└─────────────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  步驟 4: 送出銷退單                                                      │
│  ─────────────────                                                      │
│  - 查看已產生的 BRO 清單                                                 │
│  - 點擊「送出」                                                          │
│  - 更新 BRO.status = RETURNED（模擬送出即完成）                          │
│  - 扣減大庫待處理區庫存                                                  │
└─────────────────────────────────────────────────────────────────────────┘
```

### 頁面欄位

#### 查詢條件

| 欄位 | 必填 | 說明 |
|------|------|------|
| 營業所 | 是 | 下拉選擇 |
| 日期區間 | 否 | 起迄日期 |
| 狀態 | 否 | PENDING / PROCESSED |

#### SRR 清單

| 欄位 | 說明 |
|------|------|
| 退庫單號 | SRR 單號 |
| 業務員 | 儲位代碼/名稱 |
| 退庫日期 | 退庫日期 |
| 品項數 | 明細筆數 |
| 狀態 | PENDING / PROCESSED |

#### SRR 明細

| 欄位 | 說明 |
|------|------|
| 產品代碼 | 產品代碼 |
| 產品名稱 | 產品名稱 |
| 批次號 | 批次號 |
| 效期 | 效期 |
| 數量 | 退庫數量 |
| 原因 | STALE / DAMAGED / RECALLED |
| 工廠 | 對應工廠代碼 |

---

## API 設計

| 方法 | 端點 | 說明 | 操作者 |
|------|------|------|--------|
| GET | /api/branch-return | 查詢銷退單清單 | 庫務 |
| GET | /api/branch-return/{broNo} | 查詢單一銷退單 | 庫務 |
| GET | /api/sales-return/pending | 查詢待處理的 SRR | 庫務 |
| GET | /api/sales-return/{returnNo}/detail | 查詢 SRR 明細 | 庫務 |
| POST | /api/branch-return/generate | 彙整 SRR 產生 BRO | 庫務 |
| PUT | /api/branch-return/{broNo}/submit | 送出銷退單（模擬） | 庫務 |

---

## Mock 說明

本專案為 Mock 模擬，工廠端不實作：
- 「送出」操作直接更新 BRO.status = RETURNED
- 無需等待工廠確認
- 送出後自動扣減大庫待處理區庫存

---

## 相關規格書

- [業務員退庫單規格書](./SalesReturnRecord.md)

---
